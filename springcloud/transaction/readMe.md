###事务相关的实践

>对事务的定义:数据库事务包含以下目的

- 为数据库操作序列提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态下仍能保持一致性的方法
- 当多个应用程序再并发访问数据库时，可以再这些应用程序之间提供一个隔离方法，以防止彼此的操作互相干扰。

> ACID 
- 原子性（Atomicity）:事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。
- 一致性（Consistency）:事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。
- 隔离性（Isolation）:多个事务并发执行时，一个事务的执行不应影响其他事务的执行。
- 持久性（Durability）:已被提交的事务对数据库的修改应该永久保存在数据库中。

> 如果不考虑事务会出现的问题

- 脏读 ：一个事务处理过程读取了另一个未提交的事务
- 不可重复读 ：不可重复读是指在对于数据库中的某个数据，一个事务范围内多次查询却返回了不同的数据值，这是由于查询间隔，被另外一个事务修改了。
- 幻读 ：幻读是事务非独立执行时发生的一种现象。例如事务T1对一个表中所有的行的某个数据项做了从“1”修改为“2”的操作，这时事务T2又对这个表中插入了一行数据项，而这个数据项的数值还是为“1”并且提交给数据库。而操作事务T1的用户如果再查看刚刚修改的数据，会发现还有一行没有修改，其实这行是从事务T2中添加的，就好像产生幻觉一样，这就是发生了幻读。

> MYSQL 提供的四种隔离级别
- Serializable（串行化）：可避免脏读、不可重复读、幻读的产生
- Repeatable read（可重复读）：可避免脏读、不可以重复读的产生
- Read committed （读已提交）：可避免脏读的发生。
- Read uncommitted （读未提交）：最低级别，任何情况都无法保证

> InnoDB 引擎锁机制
- 共享锁（S）：允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。
- 排他锁（X）：允许或者排他锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和排他写锁。
- 意向共享锁（IS）：事务打算给数据行加共享锁，事务在给一个数据行加共享锁前必须取得该表的IS锁。
- 意向排它锁（IX）：事务打算给数据行加排他锁，事务在给一个数据行加排他锁前必须取得该表的IX锁。

说明：

1）共享锁和排他锁都是行锁，意向锁都是表锁，应用中我们只会使用到共享锁和排他锁，意向锁是mysql内部使用的，不需要用户干预。

2）对于UPDATE、DELETE和INSERT语句，InnoDB会自动给涉及数据集加排他锁（X)；对于普通SELECT语句，InnoDB不会加任何锁，事务可以通过以下语句显示给记录集加共享锁或排他锁。
共享锁（S）：SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE。
排他锁（X)：SELECT * FROM table_name WHERE ... FOR UPDATE。

3）InnoDB行锁是通过给索引上的索引项加锁来实现的，因此InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁！。


